trigger:
  branches:
    include:
      - main

pool:
  name: 'Croem Build Servers'

steps:

# Install Node
- task: NodeTool@0
  inputs:
    versionSpec: '22.x'
  displayName: "Install Node.js 22.x"

# Install packages
- script: |
    echo Installing packages...
    npm install --no-audit --no-fund --prefer-offline
  displayName: "FAST Install Dependencies"

# Run Cypress Tests
- script: |
    echo Running Cypress...
    npx cypress run --browser chrome
  displayName: "Run Cypress Tests"

# Merge Mochawesome JSON reports (optional but recommended)
- script: |
    echo Merging Mochawesome reports...
    npx mochawesome-merge reports/mocha/*.json > merged-report.json
  displayName: "Merge Mochawesome JSON"

# Generate final HTML report
- script: |
    echo Generating HTML report...
    npx mochawesome-report-generator merged-report.json -o reports/mocha/html
  displayName: "Generate HTML Report"

# Upload reports as artifacts
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/mocha'
    ArtifactName: 'cypress-mocha-report'
    publishLocation: 'Container'
  displayName: "üìÅ Upload Mochawesome Reports"
