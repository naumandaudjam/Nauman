trigger:
  branches:
    include:
      - main

# ğŸ‘‡ Use your self-hosted agent pool
pool:
  name: 'Croem Build Servers'

stages:

# ========================
# ğŸ§ª Run Cypress Tests
# ========================
- stage: Test
  displayName: "Run Cypress Tests"
  jobs:
    - job: Cypress_Test_Job
      displayName: "Execute Cypress Tests"
      steps:

        # ğŸ“¦ Install Node.js (compatible version)
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: "Install Node.js"

        # ğŸ“¥ Install Dependencies
        - script: |
            npm ci
          displayName: "Install NPM Dependencies"

        # ğŸŒ Install Cypress binary
        - script: |
            npx cypress verify
          displayName: "Verify Cypress"

        # ğŸ§ª Run Cypress tests in headless mode
        - script: |
            npx cypress run
          displayName: "Run Cypress Tests"

        # ğŸ“Š Publish Cypress test results (JUnit/XML)
        - task: PublishTestResults@2
          inputs:
            testResultsFiles: '**/results/*.xml'
            testRunTitle: 'Cypress Test Results'
            mergeTestResults: true
          condition: succeededOrFailed()
          displayName: "Publish Test Results"
